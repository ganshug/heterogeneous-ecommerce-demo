---
# =============================================================================
# Shopping Cart App Server Deployment — pinned to Intel (amd64) node
#
# Placement strategy:
#   nodeAffinity: requiredDuringScheduling — MUST run on amd64 (Intel)
#                 workload-type=appserver  (set by 01-node-labels-taints.sh)
#
# Image: built by OCP S2I BuildConfig (03-appserver-build.yaml)
#        stored in internal ImageStream: shop-cart-app:latest
#
# Database: IBM Db2 (via Db2 Operator) on Power (ppc64le)
#   Db2uCluster name: db2u-ecommerce (05-db2u-cluster.yaml)
#   Service (created by operator): c-db2u-ecommerce-db2u-engn-svc.ecommerce-demo.svc.cluster.local
#   Port: 50000
#   Database: SHOPDB
#   User: db2inst1
#   Password: auto-generated by Db2 Operator (secret: c-db2u-ecommerce-instancepassword)
#
# NOTE: No imagePullSecrets — OCP global pull secret has all registry credentials
# =============================================================================
apiVersion: apps/v1
kind: Deployment
metadata:
  name: shop-cart
  namespace: ecommerce-demo
  labels:
    app: shop-cart
    tier: appserver
    arch: amd64
    app.kubernetes.io/part-of: heterogeneous-ecommerce-demo
spec:
  replicas: 1
  selector:
    matchLabels:
      app: shop-cart
  strategy:
    type: RollingUpdate
    rollingUpdate:
      maxSurge: 1
      maxUnavailable: 0
  template:
    metadata:
      labels:
        app: shop-cart
        tier: appserver
        arch: amd64
    spec:
      # -----------------------------------------------------------------------
      # Hard node affinity: MUST run on amd64 (Intel) node
      # -----------------------------------------------------------------------
      affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: kubernetes.io/arch
                    operator: In
                    values:
                      - amd64
                  - key: workload-type
                    operator: In
                    values:
                      - appserver
      initContainers:
        # Wait for the Db2u operator service port to be reachable before starting the app
        # The Db2 Operator creates service: c-db2u-ecommerce-db2u-engn-svc
        - name: wait-for-db2
          image: image-registry.openshift-image-registry.svc:5000/openshift/cli:latest
          command:
            - bash
            - -c
            - |
              echo "Waiting for Db2u service c-db2u-ecommerce-db2u-engn-svc:50000 to be ready..."
              until bash -c "echo > /dev/tcp/c-db2u-ecommerce-db2u-engn-svc/50000" 2>/dev/null; do
                echo "Db2 not ready yet, sleeping 10s..."
                sleep 10
              done
              echo "Db2 is ready!"
      containers:
        - name: shop-cart
          # Image built by OCP S2I BuildConfig (03-appserver-build.yaml)
          # Stored in the internal OCP ImageStream — no external registry pull needed.
          image: image-registry.openshift-image-registry.svc:5000/ecommerce-demo/shop-cart-app:latest
          imagePullPolicy: Always
          ports:
            - containerPort: 8080
              name: http
          env:
            # Db2u operator creates service: c-<clustername>-db2u-engn-svc
            - name: DB2_HOST
              value: "c-db2u-ecommerce-db2u-engn-svc.ecommerce-demo.svc.cluster.local"
            - name: DB2_PORT
              value: "50000"
            - name: DB2_DATABASE
              value: "SHOPDB"
            - name: DB2_USER
              value: "db2inst1"
            - name: DB2_PASSWORD
              valueFrom:
                secretKeyRef:
                  # Secret auto-generated by Db2 Operator with the db2inst1 instance password
                  name: c-db2u-ecommerce-instancepassword
                  key: password
            # Expose node and pod name inside the app for the /arch endpoint
            - name: NODE_NAME
              valueFrom:
                fieldRef:
                  fieldPath: spec.nodeName
            - name: POD_NAME
              valueFrom:
                fieldRef:
                  fieldPath: metadata.name
          resources:
            requests:
              cpu: "250m"
              memory: "256Mi"
            limits:
              cpu: "1"
              memory: "512Mi"
          livenessProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            failureThreshold: 3
          readinessProbe:
            httpGet:
              path: /ready
              port: 8080
            initialDelaySeconds: 30
            periodSeconds: 10
            timeoutSeconds: 5
            failureThreshold: 10
          startupProbe:
            httpGet:
              path: /health
              port: 8080
            initialDelaySeconds: 15
            periodSeconds: 5
            failureThreshold: 20
      terminationGracePeriodSeconds: 30
      serviceAccountName: default